const api={all:"https://openapi.programming-hero.com/api/plants",cats:"https://openapi.programming-hero.com/api/categories",byCat:id=>`https://openapi.programming-hero.com/api/category/${id}`,detail:id=>`https://openapi.programming-hero.com/api/plant/${id}`};
const $=s=>document.querySelector(s);
const el=(t,p={},c=[])=>{const e=document.createElement(t);for(const k in p){const v=p[k];if(k==="class")e.className=v;else if(k==="text")e.textContent=v;else if(k.startsWith("data-"))e.setAttribute(k,v);else e[k]=v}([].concat(c)).filter(Boolean).forEach(ch=>e.appendChild(typeof ch==="string"?document.createTextNode(ch):ch));return e};
const showSpinner=s=>{$("#spinner")&&$("#spinner").classList.toggle("hidden",!s)};
const money=n=>`৳${(Number(n)||0).toLocaleString("bn-BD")}`;
const state={activeCat:null,cart:[]};
const fetchJSON=async u=>{const r=await fetch(u);if(!r.ok)throw new Error("Network");return r.json()};

const loadCats=async()=>{showSpinner(true);try{const j=await fetchJSON(api.cats);const arr=j?.categories||j?.data||[];renderCats(arr)}catch(e){$("#catList")&&($("#catList").innerHTML='<div class="text-red-600">Failed to load categories</div>')}finally{showSpinner(false)}};
const renderCats=arr=>{const wrap=$("#catList");if(!wrap)return;wrap.innerHTML="";wrap.append(el("h3",{class:"text-lg font-semibold text-gray-800 mb-2",text:"Categories"}));const box=el("div",{class:"grid grid-cols-2 md:grid-cols-1 gap-2"});arr.forEach(c=>{const id=c?.id||c?.category_id||c?.slug||c?.name;const name=c?.name||c?.title||`Category ${id}`;const btn=el("button",{class:`btn w-full justify-start ${String(id)===String(state.activeCat)?"bg-[#15803D] text-white":"bg-white text-gray-800"} border rounded-lg`,text:name});btn.addEventListener("click",()=>{state.activeCat=id;[...box.children].forEach(b=>b.classList.remove("bg-[#15803D]","text-white"));btn.classList.add("bg-[#15803D]","text-white");loadByCategory(id)});box.append(btn)});wrap.append(box)};
const loadAll=async()=>{showSpinner(true);try{const j=await fetchJSON(api.all);const items=j?.plants||j?.data||[];renderCards(items)}catch(e){$("#cardGrid")&&($("#cardGrid").innerHTML='<p class="text-red-600">Failed to load plants</p>')}finally{showSpinner(false)}};
const loadByCategory=async id=>{showSpinner(true);try{const j=await fetchJSON(api.byCat(id));const items=j?.plants||j?.data||[];renderCards(items)}catch(e){$("#cardGrid")&&($("#cardGrid").innerHTML='<p class="text-red-600">Failed to load category items</p>')}finally{showSpinner(false)}};
const textShort=s=>{const t=String(s||"");return t.length>100?t.slice(0,97)+"...":t};
const renderCards=items=>{const grid=$("#cardGrid");if(!grid)return;grid.innerHTML="";if(!items||!items.length){grid.innerHTML='<p class="text-gray-600">No plants found</p>';return}items.forEach(p=>{const id=p?.id||p?.plant_id||p?._id||p?.slug||p?.uid;const name=p?.name||p?.title||p?.plant_name||"Unknown Plant";const img=p?.image||p?.img||p?.thumbnail||p?.photo||"";const cat=p?.category||p?.category_name||p?.type||"—";const desc=p?.short_description||p?.description||p?.details||"";const price=p?.price||p?.cost||p?.amount||0;const card=el("div",{class:"rounded-2xl bg-white p-4 shadow hover:shadow-lg transition flex flex-col"});const pic=el("img",{src:img,alt:name,class:"w-full h-40 object-cover rounded-xl mb-3 bg-gray-100"});const title=el("button",{class:"text-lg font-semibold text-gray-900 text-left hover:underline",text:name});title.addEventListener("click",()=>openModal(id));const d=el("p",{class:"text-gray-600 text-sm mt-1",text:textShort(desc)});const meta=el("div",{class:"mt-2 text-xs text-gray-500"},[el("span",{text:`Category: ${cat}`})]);const bottom=el("div",{class:"mt-auto pt-3 flex items-center justify-between"},[el("span",{class:"font-semibold text-[#15803D]",text:money(price)}),el("button",{class:"btn btn-sm rounded-full bg-[#FACC15] text-[#15803D]"},["Add to Cart"])]);bottom.lastChild.addEventListener("click",()=>addToCart({id,name,price}));card.append(pic,title,d,meta,bottom);grid.append(card)})};
const openModal=async id=>{const dlg=$("#treeModal");const box=$("#modalContent");if(!dlg||!box)return;box.innerHTML="";showSpinner(true);try{const j=await fetchJSON(api.detail(id));const p=j?.plant||j?.data||j||{};const name=p?.name||p?.title||p?.plant_name||"Tree Details";const img=p?.image||p?.img||p?.thumbnail||"";const cat=p?.category||p?.category_name||"—";const price=p?.price||0;const desc=p?.description||p?.details||"";const info=el("div",{class:"grid grid-cols-1 md:grid-cols-3 gap-4"});const left=el("div",{class:"md:col-span-1"},[el("img",{src:img,alt:name,class:"w-full h-48 object-cover rounded-xl bg-gray-100"})]);const right=el("div",{class:"md:col-span-2 space-y-2"},[el("h3",{class:"text-xl font-semibold text-gray-900",text:name}),el("div",{class:"text-sm text-gray-600"},[el("span",{text:`Category: ${cat}`})]),el("p",{class:"text-gray-700"},[desc||""]),el("div",{class:"pt-2 flex items-center justify-between"},[el("span",{class:"font-semibold text-[#15803D]",text:money(price)}),el("button",{id:"modalAdd",class:"btn rounded-full bg-[#FACC15] text-[#15803D]"},["Add to Cart"])])]);info.append(left,right);box.append(info);$("#modalAdd").addEventListener("click",()=>{addToCart({id,name,price});dlg.close()});dlg.showModal()}catch(e){box.innerHTML='<p class="text-red-600">Failed to load details</p>';dlg.showModal()}finally{showSpinner(false)}};
const addToCart=item=>{state.cart.push({...item,uid:crypto.randomUUID?.():Math.random().toString(36).slice(2)});renderCart()};
const removeFromCart=uid=>{state.cart=state.cart.filter(i=>i.uid!==uid);renderCart()};
const renderCart=()=>{const list=$("#cartList");if(!list)return;list.innerHTML="";let total=0;state.cart.forEach(i=>{total+=Number(i.price)||0;const li=el("li",{class:"flex items-center justify-between bg-gray-50 rounded-lg px-3 py-2"});const left=el("div",{class:"flex-1"},[el("p",{class:"text-sm font-medium text-gray-800",text:i.name}),el("span",{class:"text-xs text-gray-500",text:money(i.price)})]);const rm=el("button",{class:"text-gray-500 hover:text-red-600 text-lg leading-none"},["❌"]);rm.addEventListener("click",()=>removeFromCart(i.uid));li.append(left,rm);list.append(li)});$("#cartTotal")&&($("#cartTotal").textContent=money(total))};
const init=async()=>{if(!$("#catList")||!$("#cardGrid")||!$("#cartList")||!$("#cartTotal")||!$("#treeModal")||!$("#modalContent"))return;await Promise.all([loadCats(),loadAll()])};
document.addEventListener("DOMContentLoaded",init);
